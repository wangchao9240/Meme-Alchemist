# Meme Alchemist â€” æ¶æ„è®¾è®¡æ–‡æ¡£

> **è®¾è®¡åŸåˆ™**ï¼šé›¶æˆæœ¬å¯åŠ¨ã€æç®€éƒ¨ç½²ã€æ€§èƒ½ä¼˜å…ˆã€å¯é é™çº§

---

## ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#1-æ¶æ„æ¦‚è§ˆ)
2. [æŠ€æœ¯æ ˆé€‰å‹](#2-æŠ€æœ¯æ ˆé€‰å‹)
3. [ç³»ç»Ÿæ¶æ„](#3-ç³»ç»Ÿæ¶æ„)
4. [æ•°æ®æ¶æ„](#4-æ•°æ®æ¶æ„)
5. [API è®¾è®¡](#5-api-è®¾è®¡)
6. [ç¼“å­˜ç­–ç•¥](#6-ç¼“å­˜ç­–ç•¥)
7. [æ¸²æŸ“å¼•æ“](#7-æ¸²æŸ“å¼•æ“)
8. [éƒ¨ç½²æ–¹æ¡ˆ](#8-éƒ¨ç½²æ–¹æ¡ˆ)
9. [æˆæœ¬åˆ†æ](#9-æˆæœ¬åˆ†æ)
10. [æ€§èƒ½ä¼˜åŒ–](#10-æ€§èƒ½ä¼˜åŒ–)
11. [å®‰å…¨ä¸é™æµ](#11-å®‰å…¨ä¸é™æµ)

---

## 1. æ¶æ„æ¦‚è§ˆ

### 1.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç”¨æˆ·å±‚                                  â”‚
â”‚  Mobile Web (PWA) - Next.js 15 + React 19 + Tailwind           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTPS
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¾¹ç¼˜è®¡ç®—å±‚ (å…è´¹)                             â”‚
â”‚  Cloudflare Pages (é™æ€èµ„æº) + Workers (API)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ KV (ç¼“å­˜)    â”‚  â”‚ Cron (å®šæ—¶)  â”‚  â”‚ Durable Obj  â”‚          â”‚
â”‚  â”‚ - trends     â”‚  â”‚ - 23:00 UTC  â”‚  â”‚ (å¯é€‰é™æµ)   â”‚          â”‚
â”‚  â”‚ - rate limit â”‚  â”‚ - ingest     â”‚  â”‚              â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚            â”‚
        â–¼            â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase    â”‚ â”‚ LLM API     â”‚ â”‚ çƒ­æ¦œæº      â”‚
â”‚ (å…è´¹å±‚)    â”‚ â”‚ (æŒ‰éœ€é€‰æ‹©)  â”‚ â”‚ (å…¬å¼€API)   â”‚
â”‚             â”‚ â”‚             â”‚ â”‚             â”‚
â”‚ - Postgres  â”‚ â”‚ - 4o-mini   â”‚ â”‚ - å¾®åšçƒ­æœ  â”‚
â”‚ - Storage   â”‚ â”‚ - Doubao    â”‚ â”‚ - çŸ¥ä¹çƒ­æ¦œ  â”‚
â”‚ - Auth(å¯é€‰)â”‚ â”‚ - Qwen      â”‚ â”‚ - Github    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å…³é”®ç‰¹æ€§

| ç‰¹æ€§ | æ–¹æ¡ˆ | æˆæœ¬ |
|------|------|------|
| å‰ç«¯æ‰˜ç®¡ | Cloudflare Pages | **å…è´¹** æ— é™è¯·æ±‚ |
| API/Cron | Cloudflare Workers | **å…è´¹** 10ä¸‡è¯·æ±‚/å¤© |
| æ•°æ®åº“ | Supabase | **å…è´¹** 500MB + 2GBå¸¦å®½/æœˆ |
| å¯¹è±¡å­˜å‚¨ | Supabase Storage | **å…è´¹** 1GB |
| ç¼“å­˜ | Cloudflare KV | **å…è´¹** 10ä¸‡è¯»/å¤© |
| LLM | OpenAI 4o-mini | **$0.15/1M tokens** |
| å›¾ç‰‡æ¸²æŸ“ | Satori (æœ¬åœ°) | **å…è´¹** |

**é¢„ä¼°æœˆæˆæœ¬**ï¼š$0-5ï¼ˆä»… LLM è°ƒç”¨ï¼‰

---

## 2. æŠ€æœ¯æ ˆé€‰å‹

### 2.1 å‰ç«¯æŠ€æœ¯æ ˆ

```yaml
æ¡†æ¶: Next.js 15 (App Router)
UIåº“: React 19
æ ·å¼: Tailwind CSS 4
çŠ¶æ€ç®¡ç†: Zustand (è½»é‡)
è¯·æ±‚åº“: fetch + SWR (è‡ªåŠ¨ç¼“å­˜)
PWA: next-pwa
å›¾æ ‡: Lucide React
å­—ä½“: Google Fonts (Noto Sans SC)
```

**é€‰å‹ç†ç”±**ï¼š
- Next.js 15 â†’ è‡ªå¸¦ SSR/SSGï¼ŒCloudflare Pages åŸç”Ÿæ”¯æŒ
- Zustand â†’ æ¯” Redux è½» 90%ï¼Œé€‚åˆå°é¡¹ç›®
- SWR â†’ è‡ªåŠ¨ç¼“å­˜ã€é‡è¯•ã€å»é‡ï¼Œé™ä½ API è°ƒç”¨

### 2.2 åç«¯æŠ€æœ¯æ ˆ

```yaml
è¿è¡Œæ—¶: Cloudflare Workers (V8 isolates)
è¯­è¨€: TypeScript 5.x
æ¡†æ¶: Hono.js (è¶…è½»é‡ï¼Œ3.5KB)
ORM: Drizzle ORM (type-safe, edge-ready)
éªŒè¯: Zod
é™æµ: åŸºäº KV + Durable Objects
å®šæ—¶ä»»åŠ¡: Cloudflare Cron Triggers
```

**é€‰å‹ç†ç”±**ï¼š
- Hono.js â†’ æ¯” Express å¿« 10xï¼Œä¸“ä¸º Edge ä¼˜åŒ–
- Drizzle ORM â†’ æ¯” Prisma è½»ï¼Œæ”¯æŒ Cloudflare Workers
- Zod â†’ è¿è¡Œæ—¶ç±»å‹éªŒè¯ï¼Œé˜²æ­¢è„æ•°æ®

### 2.3 æ•°æ®ä¸å­˜å‚¨

```yaml
ä¸»æ•°æ®åº“: Supabase Postgres 15
ç¼“å­˜å±‚1: Cloudflare KV (Edge)
ç¼“å­˜å±‚2: Supabase è‡ªå¸¦ PostgREST ç¼“å­˜
å¯¹è±¡å­˜å‚¨: Supabase Storage (S3å…¼å®¹)
```

### 2.4 LLM æœåŠ¡é€‰æ‹©

**å¤šå‚å•†é™çº§ç­–ç•¥**ï¼š

| ä¼˜å…ˆçº§ | æœåŠ¡å•† | æ¨¡å‹ | ä»·æ ¼ | å»¶è¿Ÿ | ç”¨é€” |
|--------|--------|------|------|------|------|
| P0 | OpenAI | gpt-4o-mini | $0.15/1M | ~1s | ä¸»åŠ›ç”Ÿæˆ |
| P1 | Doubao (å­—èŠ‚) | doubao-lite-4k | $0.07/1M | ~1.5s | é™çº§å¤‡é€‰ |
| P2 | æœ¬åœ°æ¨¡æ¿ | æ—  | å…è´¹ | <100ms | æœ€ç»ˆé™çº§ |

**é…ç½®å»ºè®®**ï¼š
```typescript
// ç¯å¢ƒå˜é‡
LLM_PRIMARY=openai:gpt-4o-mini
LLM_FALLBACK=doubao:doubao-lite-4k
LLM_TIMEOUT=8000 // 8ç§’è¶…æ—¶
```

### 2.5 å›¾ç‰‡æ¸²æŸ“æ–¹æ¡ˆ

**é€‰å‹ï¼šSatori + Sharp**

```yaml
æ–‡æœ¬â†’SVG: Satori (@vercel/og)
SVGâ†’PNG: Sharp (WASM ç‰ˆæœ¬)
å­—ä½“: Google Fonts (é¢„åŠ è½½ .ttf)
ä¼˜åŒ–: TinyPNG API (å¯é€‰)
```

**ä¼˜åŠ¿**ï¼š
- âœ… å®Œå…¨æœ¬åœ°æ¸²æŸ“ï¼Œæ— å¤–éƒ¨ä¾èµ–
- âœ… Workers å†…è¿è¡Œï¼Œ<100ms
- âœ… æ”¯æŒä¸­æ–‡å­—ä½“ï¼ˆNoto Sans SCï¼‰

---

## 3. ç³»ç»Ÿæ¶æ„

### 3.1 ç›®å½•ç»“æ„

```
meme-alchemist/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ web/                    # Next.js å‰ç«¯
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”‚   â”œâ”€â”€ (routes)/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx           # é¦–é¡µ
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ try/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ page.tsx       # ç”Ÿæˆé¡µ
â”‚   â”‚   â”‚   â”œâ”€â”€ api/                   # Next.js API (æœ¬åœ°å¼€å‘)
â”‚   â”‚   â”‚   â””â”€â”€ layout.tsx
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ composer/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TopicSelector.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ FactPicker.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ TemplateGrid.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ viewer/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MemeViewer.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ EvidencePanel.tsx
â”‚   â”‚   â”‚   â””â”€â”€ ui/
â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”‚   â”œâ”€â”€ api-client.ts          # API å°è£…
â”‚   â”‚   â”‚   â””â”€â”€ stores/                # Zustand stores
â”‚   â”‚   â””â”€â”€ public/
â”‚   â”‚       â””â”€â”€ templates/             # æ¨¡æ¿ JSON
â”‚   â”‚
â”‚   â””â”€â”€ workers/                # Cloudflare Workers
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ index.ts               # ä¸»è·¯ç”±
â”‚       â”‚   â”œâ”€â”€ routes/
â”‚       â”‚   â”‚   â”œâ”€â”€ trends.ts          # çƒ­æ¦œ API
â”‚       â”‚   â”‚   â”œâ”€â”€ jit.ts             # JIT å–æ
â”‚       â”‚   â”‚   â”œâ”€â”€ compose.ts         # LLM ç”Ÿæˆ
â”‚       â”‚   â”‚   â””â”€â”€ render.ts          # å›¾ç‰‡æ¸²æŸ“
â”‚       â”‚   â”œâ”€â”€ services/
â”‚       â”‚   â”‚   â”œâ”€â”€ llm/
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ openai.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ doubao.ts
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ fallback.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ trends/
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ fetcher.ts     # æŠ“å–é€»è¾‘
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ analyzer.ts    # èšç±»ç®—æ³•
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ sources/       # å„çƒ­æ¦œæº
â”‚       â”‚   â”‚   â”œâ”€â”€ renderer/
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ satori.ts
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ templates.ts
â”‚       â”‚   â”‚   â””â”€â”€ db.ts              # Drizzle å®¢æˆ·ç«¯
â”‚       â”‚   â”œâ”€â”€ cron/
â”‚       â”‚   â”‚   â””â”€â”€ daily-trends.ts    # å®šæ—¶ä»»åŠ¡
â”‚       â”‚   â””â”€â”€ middleware/
â”‚       â”‚       â”œâ”€â”€ rate-limit.ts
â”‚       â”‚       â””â”€â”€ error-handler.ts
â”‚       â””â”€â”€ wrangler.toml              # Workers é…ç½®
â”‚
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ shared/                 # å…±äº«ä»£ç 
â”‚   â”‚   â”œâ”€â”€ types/              # TypeScript ç±»å‹
â”‚   â”‚   â”œâ”€â”€ schemas/            # Zod schemas
â”‚   â”‚   â””â”€â”€ constants.ts
â”‚   â””â”€â”€ db/                     # æ•°æ®åº“ schema
â”‚       â”œâ”€â”€ schema.ts           # Drizzle schema
â”‚       â””â”€â”€ migrations/
â”‚
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ migrations/             # SQL è¿ç§»æ–‡ä»¶
â”‚   â””â”€â”€ seed.sql                # ç§å­æ•°æ®
â”‚
â””â”€â”€ scripts/
    â”œâ”€â”€ seed-facts.ts           # å¯¼å…¥äº‹å®å¡
    â””â”€â”€ deploy.sh               # ä¸€é”®éƒ¨ç½²
```

### 3.2 æ ¸å¿ƒæ¨¡å—è®¾è®¡

#### 3.2.1 çƒ­æ¦œåˆ†æå¼•æ“

```typescript
// workers/src/services/trends/analyzer.ts

interface TrendAnalyzer {
  // 1. æ ‡å‡†åŒ–
  normalize(raw: TrendRaw[]): NormalizedTrend[];
  
  // 2. å»é‡ï¼ˆåŸºäº hashï¼‰
  deduplicate(trends: NormalizedTrend[]): NormalizedTrend[];
  
  // 3. èšç±»ï¼ˆJaccard ç›¸ä¼¼åº¦ï¼‰
  cluster(trends: NormalizedTrend[]): TrendCluster[];
  
  // 4. æ‰“åˆ†
  score(clusters: TrendCluster[]): ScoredTopic[];
  
  // 5. ç¼“å­˜
  cache(topics: ScoredTopic[], date: string): Promise<void>;
}

// ç®€åŒ–çš„èšç±»ç®—æ³•
function jaccardSimilarity(a: string, b: string): number {
  const setA = new Set(tokenize(a));
  const setB = new Set(tokenize(b));
  const intersection = new Set([...setA].filter(x => setB.has(x)));
  const union = new Set([...setA, ...setB]);
  return intersection.size / union.size;
}
```

#### 3.2.2 LLM è°ƒç”¨å±‚

```typescript
// workers/src/services/llm/orchestrator.ts

class LLMOrchestrator {
  async generate(request: ComposeRequest): Promise<ComposeResponse> {
    // ä¼˜å…ˆçº§é“¾
    const providers = [
      { name: 'openai', timeout: 8000 },
      { name: 'doubao', timeout: 10000 },
      { name: 'fallback', timeout: 0 } // æ¨¡æ¿åŒ–æ–‡æ¡ˆ
    ];
    
    for (const provider of providers) {
      try {
        const result = await Promise.race([
          this.callProvider(provider.name, request),
          this.timeout(provider.timeout)
        ]);
        return result;
      } catch (error) {
        console.error(`${provider.name} failed, trying next...`);
        continue;
      }
    }
    
    // æœ€ç»ˆé™çº§
    return this.templateFallback(request);
  }
  
  private templateFallback(req: ComposeRequest): ComposeResponse {
    // åŸºäºæ¨¡æ¿ç”Ÿæˆå›ºå®šæ–‡æ¡ˆ
    return {
      topic: req.topic,
      angle: req.angle,
      hook: `å…³äº"${req.topic}"çš„${req.angle}è§£è¯»`,
      body: req.facts.map(f => `â€¢ ${f.quote}`).join('\n'),
      facts: req.facts
    };
  }
}
```

#### 3.2.3 æ¸²æŸ“å¼•æ“

```typescript
// workers/src/services/renderer/satori.ts

import satori from 'satori';
import { Resvg } from '@resvg/resvg-wasm';

async function renderTemplate(
  template: Template,
  payload: Record<string, string>,
  ratio: string
): Promise<Uint8Array> {
  // 1. æ ¹æ® ratio è°ƒæ•´ç”»å¸ƒ
  const dimensions = RATIO_MAP[ratio]; // {w, h}
  
  // 2. Satori ç”Ÿæˆ SVG
  const svg = await satori(
    buildJSXFromTemplate(template, payload),
    {
      width: dimensions.w,
      height: dimensions.h,
      fonts: await loadFonts(['Noto Sans SC'])
    }
  );
  
  // 3. SVG â†’ PNG
  const resvg = new Resvg(svg, {
    fitTo: { mode: 'width', value: dimensions.w }
  });
  
  return resvg.render().asPng();
}
```

---

## 4. æ•°æ®æ¶æ„

### 4.1 æ•°æ®åº“ Schema (Drizzle)

```typescript
// packages/db/schema.ts

import { pgTable, uuid, text, timestamp, jsonb, index, real, date, integer } from 'drizzle-orm/pg-core';

// äº‹å®å¡
export const facts = pgTable('facts', {
  id: uuid('id').primaryKey().defaultRandom(),
  quote: text('quote').notNull(),
  sourceTitle: text('source_title'),
  url: text('url').notNull(),
  publisher: text('publisher'),
  date: date('date'),
  tags: text('tags').array(),
  level: text('level', { enum: ['A', 'B', 'C', 'D'] }),
  confidence: real('confidence'),
  createdAt: timestamp('created_at').defaultNow()
}, (table) => ({
  tagsIdx: index('idx_facts_tags').using('gin', table.tags),
  levelConfIdx: index('idx_facts_level_conf').on(table.level, table.confidence),
  dateIdx: index('idx_facts_date').on(table.date)
}));

// çƒ­æ¦œåŸå§‹æ•°æ®
export const trendsRaw = pgTable('trends_raw', {
  id: uuid('id').primaryKey().defaultRandom(),
  source: text('source').notNull(), // 'weibo' | 'zhihu' | 'github'
  date: date('date').notNull(),
  rank: integer('rank').notNull(),
  title: text('title').notNull(),
  url: text('url'),
  hash: text('hash').notNull(), // MD5(source+title)
  createdAt: timestamp('created_at').defaultNow()
}, (table) => ({
  dateSourceIdx: index('idx_trends_raw_date_source').on(table.date, table.source),
  hashIdx: index('idx_trends_raw_hash').on(table.hash)
}));

// çƒ­æ¦œç¼“å­˜ï¼ˆæœ€ç»ˆè¾“å‡ºï¼‰
export const trendsCache = pgTable('trends_cache', {
  date: date('date').primaryKey(),
  payload: jsonb('payload').notNull(), // ScoredTopic[]
  createdAt: timestamp('created_at').defaultNow()
});

// ä½œå“
export const drafts = pgTable('drafts', {
  id: uuid('id').primaryKey().defaultRandom(),
  topic: text('topic').notNull(),
  angle: text('angle').notNull(),
  facts: jsonb('facts').notNull(), // Fact[]
  body: text('body').notNull(),
  createdAt: timestamp('created_at').defaultNow()
});

// ç”Ÿæˆçš„å›¾ç‰‡
export const assets = pgTable('assets', {
  id: uuid('id').primaryKey().defaultRandom(),
  draftId: uuid('draft_id').references(() => drafts.id),
  type: text('type').default('png'),
  path: text('path').notNull(), // Supabase Storage path
  ratios: text('ratios').array(), // ['1:1', '4:5', '9:16']
  createdAt: timestamp('created_at').defaultNow()
});
```

### 4.2 Supabase é…ç½®

**Row Level Security (RLS)**ï¼š

```sql
-- äº‹å®å¡ï¼šåªè¯»
ALTER TABLE facts ENABLE ROW LEVEL SECURITY;
CREATE POLICY "facts_read_all" ON facts FOR SELECT USING (true);

-- çƒ­æ¦œç¼“å­˜ï¼šåªè¯»
ALTER TABLE trends_cache ENABLE ROW LEVEL SECURITY;
CREATE POLICY "trends_cache_read_all" ON trends_cache FOR SELECT USING (true);

-- ä½œå“ï¼šå…¬å¼€è¯»
ALTER TABLE drafts ENABLE ROW LEVEL SECURITY;
CREATE POLICY "drafts_read_all" ON drafts FOR SELECT USING (true);
```

**Storage Bucket**ï¼š

```sql
-- åˆ›å»ºå…¬å¼€ bucket
INSERT INTO storage.buckets (id, name, public)
VALUES ('meme-images', 'meme-images', true);

-- å…è®¸ä¸Šä¼ ï¼ˆä»… Worker service roleï¼‰
CREATE POLICY "worker_upload" ON storage.objects
  FOR INSERT WITH CHECK (bucket_id = 'meme-images');
```

---

## 5. API è®¾è®¡

### 5.1 RESTful ç«¯ç‚¹

**å‰å° APIï¼ˆå…¬å¼€ï¼‰**

```typescript
// GET /api/trends
// è·å–ä»Šæ—¥çƒ­æ¦œ TopN
Response: {
  date: string;
  topics: Array<{
    topic_id: string;
    label: string;      // "æ˜¥èŠ‚æ”¾å‡å®‰æ’"
    score: number;
    samples: string[];  // åŸå§‹æ ‡é¢˜æ ·æœ¬
  }>;
}

// POST /api/jit_fetch
// JIT å–æ
Request: {
  topic: string;
  collections: string[];  // ["AIæœ¯è¯­", "Brisbaneç”Ÿæ´»"]
  limit?: number;         // default 6
}
Response: {
  candidates: Array<{
    id: string;
    quote: string;
    source_title: string;
    url: string;
    level: 'A' | 'B' | 'C' | 'D';
    confidence: number;
  }>;
}

// POST /api/compose
// LLM ç”Ÿæˆæ–‡æ¡ˆ
Request: {
  topic: string;
  angle: 'ç§‘æ™®' | 'è‡ªå˜²' | 'åå·®' | 'å†…å¹•';
  template_id: string;
  facts: Array<{ quote: string; source: string }>;
}
Response: {
  topic: string;
  angle: string;
  hook: string;
  body: string;
  facts: Array<{ quote: string; source: string }>;
  platform_fit: Array<{ platform: string; chars_max: number }>;
}

// POST /api/render
// æ¸²æŸ“å›¾ç‰‡
Request: {
  template_id: string;
  payload: Record<string, string>;  // {title, left, right, note}
  ratios: string[];                 // ['1:1', '4:5', '9:16']
}
Response: {
  images: Array<{
    ratio: string;
    url: string;  // Supabase Storage CDN URL
  }>;
  asset_id: string;
}
```

**åå° APIï¼ˆé™åˆ¶è®¿é—®ï¼‰**

```typescript
// POST /admin/trends/ingest
// æŠ“å–çƒ­æ¦œï¼ˆéœ€ API Keyï¼‰
Headers: { Authorization: Bearer <ADMIN_KEY> }
Response: {
  fetched: number;
  sources: string[];
}

// POST /admin/trends/analyze
// åˆ†æèšç±»ï¼ˆéœ€ API Keyï¼‰
Headers: { Authorization: Bearer <ADMIN_KEY> }
Response: {
  topics: number;
  cached_date: string;
}
```

### 5.2 é”™è¯¯ç è§„èŒƒ

```typescript
{
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "æ¯å°æ—¶é™åˆ¶ 10 æ¬¡ï¼Œè¯·ç¨åå†è¯•",
    "retry_after": 3600
  }
}
```

**æ ‡å‡†é”™è¯¯ç **ï¼š

| Code | HTTP | å«ä¹‰ |
|------|------|------|
| `RATE_LIMIT_EXCEEDED` | 429 | è¶…è¿‡é™é¢‘ |
| `INSUFFICIENT_FACTS` | 400 | å€™é€‰äº‹å®ä¸è¶³ |
| `LLM_TIMEOUT` | 504 | LLM è°ƒç”¨è¶…æ—¶ |
| `RENDER_FAILED` | 500 | æ¸²æŸ“å¤±è´¥ |
| `INVALID_TEMPLATE` | 400 | æ¨¡æ¿ä¸å­˜åœ¨ |

---

## 6. ç¼“å­˜ç­–ç•¥

### 6.1 ä¸‰å±‚ç¼“å­˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1: Cloudflare KV (è¾¹ç¼˜, TTL 1h-24h)      â”‚
â”‚  - /api/trends â†’ 24h                        â”‚
â”‚  - çƒ­é—¨æ¨¡æ¿é…ç½® â†’ 12h                       â”‚
â”‚  - é™æµè®¡æ•° â†’ 1h                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ Miss
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L2: Supabase PostgREST Cache (1h)          â”‚
â”‚  - facts è¡¨æŸ¥è¯¢ç»“æœ                         â”‚
â”‚  - trends_cache è¡¨                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ Miss
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L3: Postgres (æºæ•°æ®)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ç¼“å­˜é”®è®¾è®¡

```typescript
// KV é”®å‘½åè§„èŒƒ
const CACHE_KEYS = {
  TRENDS: (date: string) => `trends:${date}`,           // trends:2025-01-10
  FACTS: (tags: string) => `facts:${tags}`,             // facts:AU,å¤©æ°”
  RATE_LIMIT: (ip: string) => `rl:${ip}:${hour}`,      // rl:1.2.3.4:2025011010
  SEED_TOPICS: 'seed:topics'                            // ç§å­è¯é¢˜
};
```

### 6.3 ç¼“å­˜å¤±æ•ˆç­–ç•¥

| æ•°æ®ç±»å‹ | TTL | å¤±æ•ˆè§¦å‘ |
|---------|-----|---------|
| çƒ­æ¦œç¼“å­˜ | 24h | æ¯æ—¥ 09:00 AEST å®šæ—¶åˆ·æ–° |
| Facts æŸ¥è¯¢ | 1h | æ–°å¢ fact æ—¶æ¸…ç©ºç›¸å…³ tag ç¼“å­˜ |
| é™æµè®¡æ•° | 1h | è‡ªåŠ¨è¿‡æœŸ |
| æ¨¡æ¿é…ç½® | 12h | æ‰‹åŠ¨æ¸…ç©º |

---

## 7. æ¸²æŸ“å¼•æ“

### 7.1 æ¨¡æ¿ç³»ç»Ÿè®¾è®¡

**æ¨¡æ¿ DSL å®Œæ•´ Schema**ï¼š

```typescript
interface Template {
  id: string;              // 'two-panel-v1'
  name: string;            // 'ä¸¤æ å¯¹æ¯”'
  type: 'meme_image';
  canvas: {
    w: number;             // 1080
    h: number;             // 1350
    bg: string;            // '#0f0f0f' or 'linear-gradient(...)'
  };
  slots: Slot[];
  styles: StyleSheet;      // CSS-in-JS æ ·å¼
  ratios: string[];        // æ”¯æŒçš„æ¯”ä¾‹
}

interface Slot {
  name: string;            // 'title' | 'left' | 'right' | 'note'
  kind: 'text' | 'image' | 'divider';
  x: number;               // ç»å¯¹å®šä½ x
  y: number;               // ç»å¯¹å®šä½ y
  w: number;               // å®½åº¦
  h?: number;              // é«˜åº¦ï¼ˆæ–‡æœ¬å¯çœç•¥ï¼‰
  style: string;           // å¼•ç”¨ styles ä¸­çš„æ ·å¼å
  maxLines?: number;       // æ–‡æœ¬æœ€å¤§è¡Œæ•°
}
```

**é¢„è®¾æ¨¡æ¿åˆ—è¡¨ï¼ˆMVP 6ä¸ªï¼‰**ï¼š

| ID | åç§° | é€‚ç”¨è§’åº¦ | æ’æ§½æ•° |
|----|------|----------|--------|
| `two-panel-v1` | ä¸¤æ å¯¹æ¯” | åå·® | 4 |
| `grid-9-v1` | ä¹å®«æ ¼ | ç§‘æ™® | 10 |
| `timeline-v1` | æ—¶é—´çº¿ | å†…å¹• | 5 |
| `glossary-v1` | è¯æ¡è§£é‡Š | ç§‘æ™® | 3 |
| `datapoint-v1` | æ•°æ®ç‚¹ | ç§‘æ™® | 6 |
| `flowchart-v1` | æµç¨‹å›¾ | è‡ªå˜² | 4 |

### 7.2 å­—ä½“åŠ è½½ç­–ç•¥

```typescript
// workers/src/services/renderer/fonts.ts

const FONT_CACHE = new Map<string, ArrayBuffer>();

async function loadFonts(names: string[]): Promise<FontData[]> {
  return Promise.all(names.map(async (name) => {
    if (!FONT_CACHE.has(name)) {
      // ä» Google Fonts æˆ– Supabase Storage åŠ è½½
      const buffer = await fetch(
        `https://fonts.googleapis.com/css2?family=${name}&display=swap`
      ).then(r => r.arrayBuffer());
      FONT_CACHE.set(name, buffer);
    }
    
    return {
      name,
      data: FONT_CACHE.get(name)!,
      weight: 400,
      style: 'normal'
    };
  }));
}
```

### 7.3 æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–

**ç›®æ ‡**ï¼šå•å¼ å›¾ <100ms

1. **å­—ä½“é¢„åŠ è½½**ï¼šWorker å¯åŠ¨æ—¶åŠ è½½å¸¸ç”¨å­—ä½“åˆ°å†…å­˜
2. **æ¨¡æ¿ç¼“å­˜**ï¼šæ¨¡æ¿ JSON å­˜å…¥ KV
3. **æ‰¹é‡æ¸²æŸ“**ï¼š3 ä¸ªæ¯”ä¾‹å¹¶è¡Œç”Ÿæˆ
4. **æµå¼ä¸Šä¼ **ï¼šè¾¹æ¸²æŸ“è¾¹ä¸Šä¼ åˆ° Supabase Storage

```typescript
async function renderMultiRatios(
  template: Template,
  payload: Record<string, string>,
  ratios: string[]
): Promise<ImageResult[]> {
  return Promise.all(
    ratios.map(ratio => renderTemplate(template, payload, ratio))
  );
}
```

---

## 8. éƒ¨ç½²æ–¹æ¡ˆ

### 8.1 Cloudflare Workers é…ç½®

```toml
# workers/wrangler.toml

name = "meme-alchemist-api"
main = "src/index.ts"
compatibility_date = "2024-01-01"

# KV ç»‘å®š
[[kv_namespaces]]
binding = "CACHE"
id = "xxxxx"                    # ç”Ÿäº§ç¯å¢ƒ ID

[[kv_namespaces]]
binding = "CACHE"
id = "yyyyy"
preview_id = "zzzzz"            # é¢„è§ˆç¯å¢ƒ ID

# å®šæ—¶ä»»åŠ¡
[triggers]
crons = ["0 23 * * *"]          # æ¯å¤© 23:00 UTC (09:00 AEST)

# ç¯å¢ƒå˜é‡
[vars]
SUPABASE_URL = "https://xxx.supabase.co"
WHITE_LISTED_DOMAINS = "mdn.mozilla.org,python.org,bom.gov.au"

# å¯†é’¥ï¼ˆé€šè¿‡ wrangler secret put è®¾ç½®ï¼‰
# SUPABASE_SERVICE_KEY
# OPENAI_API_KEY
# DOUBAO_API_KEY
# ADMIN_KEY
```

### 8.2 Cloudflare Pages é…ç½®

```toml
# apps/web/next.config.mjs

/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'export',               // é™æ€å¯¼å‡º
  images: {
    unoptimized: true,            // Pages ä¸æ”¯æŒ Image Optimization
    domains: ['xxx.supabase.co']  // Supabase Storage
  },
  env: {
    NEXT_PUBLIC_API_URL: process.env.API_URL || 'https://api.meme-alchemist.workers.dev'
  }
};

export default nextConfig;
```

### 8.3 ä¸€é”®éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# scripts/deploy.sh

set -e

echo "ğŸš€ éƒ¨ç½² Meme Alchemist..."

# 1. æ„å»ºå‰ç«¯
cd apps/web
pnpm build
echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"

# 2. éƒ¨ç½²åˆ° Cloudflare Pages
npx wrangler pages deploy out --project-name=meme-alchemist
echo "âœ… å‰ç«¯å·²éƒ¨ç½²"

# 3. éƒ¨ç½² Workers
cd ../workers
pnpm run deploy
echo "âœ… API å·²éƒ¨ç½²"

# 4. è¿è¡Œæ•°æ®åº“è¿ç§»
cd ../../
pnpm run db:migrate
echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"

echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
echo "å‰ç«¯: https://meme-alchemist.pages.dev"
echo "API: https://api.meme-alchemist.workers.dev"
```

### 8.4 ç¯å¢ƒå˜é‡æ¸…å•

**.env.example**ï¼š

```bash
# Supabase
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... (ä»… Workers)

# LLM
OPENAI_API_KEY=sk-...
DOUBAO_API_KEY=... (å¯é€‰)

# Workers
ADMIN_KEY=your-secure-random-key
WHITE_LISTED_DOMAINS=mdn.mozilla.org,python.org,bom.gov.au,gov.cn,who.int

# å‰ç«¯
NEXT_PUBLIC_API_URL=https://api.meme-alchemist.workers.dev
```

---

## 9. æˆæœ¬åˆ†æ

### 9.1 å…è´¹é¢åº¦æ˜ç»†

| æœåŠ¡ | å…è´¹é¢åº¦ | é¢„ä¼°ç”¨é‡ | è¶…é¢æˆæœ¬ |
|------|---------|---------|---------|
| **Cloudflare Pages** | æ— é™è¯·æ±‚ | ~500 PV/å¤© | $0 |
| **Cloudflare Workers** | 10ä¸‡è¯·æ±‚/å¤© | ~200 è¯·æ±‚/å¤© | $5/æœˆ (è¶…é¢å) |
| **Cloudflare KV** | 10ä¸‡è¯»/å¤©, 1000å†™/å¤© | ~500è¯»/å¤© | $0.50/ç™¾ä¸‡è¯» |
| **Supabase DB** | 500MB, 2GBå¸¦å®½/æœˆ | ~50MB, 500MBå¸¦å®½ | $0 |
| **Supabase Storage** | 1GB | ~100MB (å›¾ç‰‡) | $0 |
| **OpenAI 4o-mini** | æŒ‰é‡è®¡è´¹ | ~50K tokens/å¤© | $0.15/ç™¾ä¸‡ tokens |

### 9.2 æœˆæˆæœ¬ä¼°ç®—

**ä½æµé‡åœºæ™¯ï¼ˆ100 PV/å¤©ï¼Œ3 æ¬¡ç”Ÿæˆ/å¤©ï¼‰**ï¼š

```
OpenAI API:
  3æ¬¡ Ã— 30å¤© Ã— 500 tokens = 45K tokens/æœˆ
  $0.15/1M Ã— 0.045M = $0.0068 â‰ˆ $0.01

æ€»è®¡: ~$0.01/æœˆ
```

**ä¸­ç­‰æµé‡åœºæ™¯ï¼ˆ1000 PV/å¤©ï¼Œ30 æ¬¡ç”Ÿæˆ/å¤©ï¼‰**ï¼š

```
OpenAI API:
  30æ¬¡ Ã— 30å¤© Ã— 500 tokens = 450K tokens/æœˆ
  $0.15/1M Ã— 0.45M = $0.0675 â‰ˆ $0.07

Workers (ä»åœ¨å…è´¹é¢åº¦å†…)
Supabase (ä»åœ¨å…è´¹é¢åº¦å†…)

æ€»è®¡: ~$0.07/æœˆ
```

**é«˜æµé‡åœºæ™¯ï¼ˆ10000 PV/å¤©ï¼Œ300 æ¬¡ç”Ÿæˆ/å¤©ï¼‰**ï¼š

```
OpenAI API:
  300æ¬¡ Ã— 30å¤© Ã— 500 tokens = 4.5M tokens/æœˆ
  $0.15/1M Ã— 4.5M = $0.68

Workers:
  300æ¬¡ Ã— 30å¤© = 9000 è¯·æ±‚/æœˆ (ä»åœ¨å…è´¹é¢åº¦å†…)

Supabase:
  å¯èƒ½éœ€è¦å‡çº§åˆ° Pro ($25/æœˆ) è·å¾—æ›´é«˜å¸¦å®½

æ€»è®¡: ~$0.68 - $25.68/æœˆï¼ˆå–å†³äºæ˜¯å¦å‡çº§ Supabaseï¼‰
```

### 9.3 æˆæœ¬ä¼˜åŒ–å»ºè®®

1. **LLM é™çº§**ï¼šä¸»åŠ›ç”¨ 4o-miniï¼Œé™çº§ç”¨ Doubao (æ›´ä¾¿å®œ)
2. **ç§¯æç¼“å­˜**ï¼šçƒ­æ¦œç¼“å­˜ 24hï¼Œå‡å°‘ DB æŸ¥è¯¢
3. **CDN ä¼˜åŒ–**ï¼šSupabase Storage è‡ªå¸¦ CDNï¼Œå›¾ç‰‡æ°¸ä¹…ç¼“å­˜
4. **æ‰¹é‡ç”Ÿæˆ**ï¼šé¼“åŠ±ç”¨æˆ·ä¸€æ¬¡ç”Ÿæˆå¤šæ¯”ä¾‹ï¼Œåˆ†æ‘Šæˆæœ¬

---

## 10. æ€§èƒ½ä¼˜åŒ–

### 10.1 å‰ç«¯ä¼˜åŒ–

**ç›®æ ‡ï¼šé¦–å± <2sï¼ˆ4G ç½‘ç»œï¼‰**

| ä¼˜åŒ–é¡¹ | æ–¹æ¡ˆ | æ”¶ç›Š |
|--------|------|------|
| ä»£ç åˆ†å‰² | Next.js è‡ªåŠ¨ code splitting | -40% JS |
| å›¾ç‰‡ä¼˜åŒ– | WebP + å“åº”å¼å›¾ç‰‡ | -60% å¸¦å®½ |
| å­—ä½“ä¼˜åŒ– | `font-display: swap` | -500ms FCP |
| é¢„åŠ è½½ | `<link rel="preconnect">` åˆ° API | -200ms |
| Service Worker | ç¼“å­˜é™æ€èµ„æº | ç¦»çº¿å¯ç”¨ |

**Critical CSS å†…è”**ï¼š

```tsx
// app/layout.tsx
export default function RootLayout({ children }) {
  return (
    <html>
      <head>
        <style dangerouslySetInnerHTML={{ __html: criticalCSS }} />
        <link rel="preconnect" href={process.env.NEXT_PUBLIC_API_URL} />
      </head>
      <body>{children}</body>
    </html>
  );
}
```

### 10.2 API ä¼˜åŒ–

**ç›®æ ‡ï¼šP95 <10s**

| ç«¯ç‚¹ | ä¼˜åŒ–æ‰‹æ®µ | P95 ç›®æ ‡ |
|------|---------|---------|
| `/api/trends` | KV ç¼“å­˜ + é¢„è®¡ç®— | <50ms |
| `/api/jit_fetch` | ç´¢å¼•ä¼˜åŒ– + limit 6 | <200ms |
| `/api/compose` | è¶…æ—¶ 8s + é™çº§ | <8s |
| `/api/render` | å¹¶è¡Œæ¸²æŸ“ + æµå¼ä¸Šä¼  | <1s |

**æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**ï¼š

```typescript
// ä½¿ç”¨ Drizzle çš„é«˜æ•ˆæŸ¥è¯¢
const candidates = await db
  .select()
  .from(facts)
  .where(
    and(
      arrayContains(facts.tags, collections),
      inArray(facts.level, ['A', 'B'])
    )
  )
  .orderBy(desc(facts.confidence))
  .limit(limit);
```

### 10.3 æ¸²æŸ“ä¼˜åŒ–

**å¹¶è¡Œæ¸²æŸ“ + æµå¼ä¸Šä¼ **ï¼š

```typescript
async function renderAndUpload(
  template: Template,
  payload: Record<string, string>,
  ratios: string[]
): Promise<ImageResult[]> {
  const uploadPromises = ratios.map(async (ratio) => {
    const pngBuffer = await renderTemplate(template, payload, ratio);
    
    // æµå¼ä¸Šä¼ åˆ° Supabase Storage
    const path = `${Date.now()}-${ratio}.png`;
    const { data } = await supabase.storage
      .from('meme-images')
      .upload(path, pngBuffer, { contentType: 'image/png' });
    
    return {
      ratio,
      url: data.publicUrl
    };
  });
  
  return Promise.all(uploadPromises);
}
```

---

## 11. å®‰å…¨ä¸é™æµ

### 11.1 é™æµç­–ç•¥

**åŸºäº Cloudflare KV çš„æ»‘åŠ¨çª—å£**ï¼š

```typescript
// workers/src/middleware/rate-limit.ts

interface RateLimitConfig {
  maxRequests: number;
  windowMs: number;
}

const LIMITS: Record<string, RateLimitConfig> = {
  '/api/compose': { maxRequests: 10, windowMs: 3600000 },  // 10æ¬¡/å°æ—¶
  '/api/render': { maxRequests: 10, windowMs: 3600000 },
  '/admin/*': { maxRequests: 100, windowMs: 3600000 }      // åå°å®½æ¾
};

async function checkRateLimit(
  ip: string,
  endpoint: string,
  kv: KVNamespace
): Promise<{ allowed: boolean; retryAfter?: number }> {
  const config = LIMITS[endpoint];
  const now = Date.now();
  const windowStart = now - config.windowMs;
  const key = `rl:${ip}:${endpoint}:${Math.floor(now / config.windowMs)}`;
  
  const count = await kv.get<number>(key, 'json') || 0;
  
  if (count >= config.maxRequests) {
    return {
      allowed: false,
      retryAfter: Math.ceil((windowStart + config.windowMs - now) / 1000)
    };
  }
  
  await kv.put(key, String(count + 1), {
    expirationTtl: Math.ceil(config.windowMs / 1000)
  });
  
  return { allowed: true };
}
```

### 11.2 è¾“å…¥éªŒè¯

**ä½¿ç”¨ Zod Schema**ï¼š

```typescript
// packages/shared/schemas/compose.ts

import { z } from 'zod';

export const ComposeRequestSchema = z.object({
  topic: z.string().min(2).max(50),
  angle: z.enum(['ç§‘æ™®', 'è‡ªå˜²', 'åå·®', 'å†…å¹•']),
  template_id: z.string().regex(/^[a-z0-9-]+$/),
  facts: z.array(
    z.object({
      quote: z.string().min(10).max(200),
      source: z.string().url()
    })
  ).min(2).max(4)
});

// ä½¿ç”¨
const validated = ComposeRequestSchema.parse(request);
```

### 11.3 é˜²æŠ¤æªæ–½

| å¨èƒ | é˜²æŠ¤æ–¹æ¡ˆ |
|------|---------|
| DDoS | Cloudflare è‡ªå¸¦é˜²æŠ¤ |
| SQL æ³¨å…¥ | Drizzle ORM å‚æ•°åŒ–æŸ¥è¯¢ |
| XSS | React è‡ªåŠ¨è½¬ä¹‰ + CSP Header |
| CSRF | SameSite Cookie (å¦‚æœ‰ç™»å½•) |
| API æ»¥ç”¨ | IP é™æµ + ADMIN_KEY éªŒè¯ |

**CSP Header**ï¼š

```typescript
// workers/src/index.ts

app.use('*', async (c, next) => {
  await next();
  c.header('Content-Security-Policy', 
    "default-src 'self'; img-src 'self' https://*.supabase.co; style-src 'self' 'unsafe-inline'"
  );
});
```

---

## é™„å½•

### A. çƒ­æ¦œæ•°æ®æº

**å…è´¹å…¬å¼€ API**ï¼š

| å¹³å° | API | å…è´¹é¢åº¦ | æ•°æ®è´¨é‡ |
|------|-----|---------|---------|
| å¾®åšçƒ­æœ | RSS / ç¬¬ä¸‰æ–¹ API | æ— é™ | â­â­â­â­ |
| çŸ¥ä¹çƒ­æ¦œ | å®˜æ–¹ API (é™æµ) | 100æ¬¡/å°æ—¶ | â­â­â­â­â­ |
| GitHub Trending | GitHub API | 5000æ¬¡/å°æ—¶ | â­â­â­ |
| V2EX çƒ­é—¨ | V2EX API | æ— é™ | â­â­â­ |

**æ¨èé…ç½®**ï¼šå¾®åš + çŸ¥ä¹ï¼ˆè¦†ç›–ä¸­æ–‡çƒ­ç‚¹ï¼‰

### B. ç›‘æ§ä¸æ—¥å¿—

**Cloudflare Analyticsï¼ˆå…è´¹ï¼‰**ï¼š

- Workers è°ƒç”¨æ¬¡æ•°
- é”™è¯¯ç‡
- P50/P95/P99 å»¶è¿Ÿ
- å¸¦å®½ä½¿ç”¨

**è‡ªå®šä¹‰æ—¥å¿—**ï¼š

```typescript
// å…³é”®è·¯å¾„æ‰“ç‚¹
console.log(JSON.stringify({
  event: 'compose_success',
  topic: request.topic,
  provider: 'openai',
  duration_ms: 2345,
  tokens: 456
}));
```

### C. æµ‹è¯•ç­–ç•¥

**å•å…ƒæµ‹è¯•**ï¼šVitest

```bash
# Workers æµ‹è¯•
cd apps/workers
pnpm test

# è¦†ç›–ç‡ç›®æ ‡
- services/: >80%
- routes/: >70%
```

**E2E æµ‹è¯•**ï¼šPlaywright

```typescript
test('å®Œæ•´ç”Ÿæˆæµç¨‹', async ({ page }) => {
  await page.goto('/try');
  await page.click('[data-topic="æ˜¥èŠ‚æ”¾å‡"]');
  await page.click('[data-template="two-panel-v1"]');
  await page.click('button:has-text("å–æ")');
  await page.locator('[data-fact]').nth(0).click();
  await page.locator('[data-fact]').nth(1).click();
  await page.click('button:has-text("ç”Ÿæˆ")');
  
  await expect(page.locator('img[alt*="æ¢—å›¾"]')).toBeVisible({ timeout: 15000 });
});
```

---

## æ€»ç»“

### âœ… æ¶æ„ä¼˜åŠ¿

1. **é›¶æˆæœ¬å¯åŠ¨**ï¼šCloudflare + Supabase å…è´¹å±‚è¶³å¤Ÿ MVP
2. **å…¨çƒåŠ é€Ÿ**ï¼šè¾¹ç¼˜è®¡ç®— + CDNï¼Œä¸­å›½/æ¾³æ´²å‡å¯å¿«é€Ÿè®¿é—®
3. **é«˜å¯ç”¨æ€§**ï¼šCloudflare 99.99% SLAï¼Œæ— éœ€è‡ªå»ºåŸºç¡€è®¾æ–½
4. **å¯æ‰©å±•æ€§**ï¼šWorkers è‡ªåŠ¨æ‰©å®¹ï¼ŒæŒ‰éœ€ä»˜è´¹
5. **å¼€å‘å‹å¥½**ï¼šTypeScript å…¨æ ˆï¼Œç±»å‹å®‰å…¨

### ğŸ“Š æŠ€æœ¯æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å®ç°æ–¹æ¡ˆ |
|------|------|---------|
| é¦–å±æ¸²æŸ“ | <2s | SSG + è¾¹ç¼˜ç¼“å­˜ |
| ç”Ÿæˆ P95 | <10s | LLM è¶…æ—¶ + é™çº§ |
| çƒ­æ¦œåˆ†æ | <5s | ç®€åŒ–èšç±»ç®—æ³• |
| å¯ç”¨æ€§ | >99.9% | Cloudflare + é™çº§ç­–ç•¥ |
| æœˆæˆæœ¬ | <$5 | å…è´¹å±‚ + 4o-mini |

### ğŸš€ ä¸‹ä¸€æ­¥

1. âœ… **æ¶æ„è¯„å®¡é€šè¿‡** â†’ å¼€å§‹ç¼–ç 
2. ğŸ“¦ åˆå§‹åŒ–ä»“åº“ï¼ˆTurborepoï¼‰
3. ğŸ—„ï¸ è®¾ç½® Supabase é¡¹ç›® + è¿è¡Œè¿ç§»
4. ğŸ¨ å®ç°å‰ç«¯æ¡†æ¶ + é¦–é¡µ
5. âš¡ å®ç°æ ¸å¿ƒ Workers API
6. ğŸ­ å®ç°æ¸²æŸ“å¼•æ“ + æ¨¡æ¿
7. ğŸ§ª E2E æµ‹è¯•
8. ğŸš¢ éƒ¨ç½²ä¸Šçº¿

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-01-10  
**ä½œè€…**ï¼šæ¶æ„å¸ˆ

